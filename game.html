<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solitaire ƒê·ªôc ƒê√°o</title>
    <!-- Favicon cho b·∫£n Public -->
    <link rel="icon" href="icon.png" type="image/png">
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- T·∫£i Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- M3 VIBE STYLING --- */
        :root {
            --card-width: 80px;
            --card-height: 120px;
            /* Deep M3 Green/Navy for table */
            --table-color: #1a1c20; 
            --surface-color: #1E3A2C; /* Surface for card slots */
            --primary-accent: #60c9ff; /* M3-like blue accent */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--table-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }

        /* ƒê·ªãnh d·∫°ng chung cho l√° b√†i v√† v√πng ch·ª©a */
        .card, .card-slot {
            width: var(--card-width);
            height: var(--card-height);
            border-radius: 12px; /* M3 rounded */
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4); /* Elevated shadow */
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        /* ƒê·ªãnh d·∫°ng v√πng ch·ª©a r·ªóng */
        .card-slot {
            background-color: var(--surface-color);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* ƒê·ªãnh d·∫°ng l√° b√†i */
        .card {
            position: absolute;
            background-color: #F8F9FA; /* Light surface */
            color: black;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            font-weight: 800;
            user-select: none;
        }

        .card-back {
            /* M3 dark card back */
            background-image: linear-gradient(135deg, #004d40 0%, #002d28 100%);
            color: #d7e8ff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: 900;
        }

        /* Hi·ªáu ·ª©ng cho l√° b√†i ƒë∆∞·ª£c ch·ªçn */
        .card.selected {
            outline: 3px solid var(--primary-accent);
            box-shadow: 0 0 15px var(--primary-accent), 0 8px 15px rgba(0, 0, 0, 0.7);
            transform: translateY(-5px);
            z-index: 100;
        }

        /* M√†u ch·∫•t b√†i (v·∫´n gi·ªØ ƒë·ªô t∆∞∆°ng ph·∫£n cao) */
        .red-suit { color: #d32f2f; }
        .black-suit { color: #1a1a1a; }

        /* X·∫øp ch·ªìng l√° b√†i trong Tableau */
        .tableau-pile > .card {
            top: 0;
            left: 0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            :root {
                --card-width: 65px;
                --card-height: 95px;
            }
            body {
                padding: 10px;
            }
            .card-slot {
                font-size: 0.7rem;
            }
        }
        
        /* Style cho N√∫t Tho√°t */
        .exit-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            z-index: 1000;
        }
        .exit-button:hover {
            background-color: #ff0000;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-[var(--table-color)]">

    <div id="game-container" class="w-full max-w-6xl p-4 bg-transparent rounded-xl relative">
        
        <!-- N√öT THO√ÅT GAME (M·ªõi th√™m) -->
        <button 
            class="exit-button" 
            onclick="window.location.href = 'https://tuanphong3108.github.io/Solitaire/index.html';" 
            title="Tho√°t Game">
            X
        </button>
        
        <!-- H√†ng Tr√™n: Stock, Waste, Foundation -->
        <div id="top-row" class="flex justify-between mb-8">
            
            <!-- Stock v√† Waste (C·ªçc R√∫t B√†i v√† B√†i ƒê√£ L·∫≠t) -->
            <div class="flex space-x-4">
                <div id="stock-slot" class="card-slot cursor-pointer flex-shrink-0" onclick="drawCard()">
                    <span id="stock-count">STOCK</span>
                </div>
                <div id="waste-slot" class="card-slot relative flex-shrink-0">
                    WASTE
                </div>
            </div>

            <!-- Foundation (4 C·ªçc M·ª•c Ti√™u) -->
            <div id="foundation-area" class="flex space-x-4">
                <!-- 4 v√πng ch·ª©a Foundation -->
                <div id="foundation-H" class="foundation-slot card-slot relative" data-suit="H">C∆†</div>
                <div id="foundation-D" class="foundation-slot card-slot relative" data-suit="D">R√î</div>
                <div id="foundation-C" class="foundation-slot card-slot relative" data-suit="C">CHU·ªíN</div>
                <div id="foundation-S" class="foundation-slot card-slot relative" data-suit="S">B√çCH</div>
            </div>
        </div>

        <!-- Tableau (7 C·ªôt Ch∆°i Ch√≠nh) -->
        <div id="tableau-area" class="flex justify-between space-x-2">
            <!-- 7 v√πng ch·ª©a Tableau -->
            <div id="tableau-0" class="tableau-slot card-slot relative flex-1 min-h-[300px]"></div>
            <div id="tableau-1" class="tableau-slot card-slot relative flex-1 min-h-[300px]"></div>
            <div id="tableau-2" class="tableau-slot card-slot relative flex-1 min-h-[300px]"></div>
            <div id="tableau-3" class="tableau-slot card-slot relative flex-1 min-h-[300px]"></div>
            <div id="tableau-4" class="tableau-slot card-slot relative flex-1 min-h-[300px]"></div>
            <div id="tableau-5" class="tableau-slot card-slot relative flex-1 min-h-[300px]"></div>
            <div id="tableau-6" class="tableau-slot card-slot relative flex-1 min-h-[300px]"></div>
        </div>
        
        <!-- B·∫£ng ƒêi·ªÅu Khi·ªÉn & Th√¥ng B√°o G·ªòP (·ªû d∆∞·ªõi c√πng) -->
        <div class="mt-8 p-4 bg-[#20252b] rounded-xl shadow-2xl border border-gray-700">
            
            <!-- H√†ng 1: N√∫t v√† ƒêi·ªÉm -->
            <div class="flex justify-between items-center pb-4 mb-4 border-b border-gray-700">
                <div class="flex space-x-4">
                    <!-- N√∫t M3 Filled Button -->
                    <button onclick="initGame()" class="px-5 py-2 bg-[var(--primary-accent)] text-gray-900 font-bold rounded-full hover:bg-[#86d9ff] transition shadow-md transform hover:scale-[1.05]">
                        CH∆†I L·∫†I (New Game)
                    </button>
                    
                </div>
                
                <div id="score-box" class="text-white text-2xl font-extrabold tracking-wider">
                    ƒêI·ªÇM: <span id="current-score" class="text-[var(--primary-accent)]">0</span>
                </div>
            </div>

            <!-- H√†ng 2: Thanh Th√¥ng b√°o -->
            <div class="pt-2">
                <div id="message-box" class="text-[var(--primary-accent)] text-center text-lg font-medium p-3 bg-[#1e2329] rounded-lg border border-gray-700 transition duration-300">
                    S·∫µn s√†ng chi·∫øn ƒë·∫•u, Phong!
                </div>
            </div>
        </div>

        <!-- Custom Modal for Win/Error Messages -->
        <div id="game-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[1000]">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
                <h3 id="modal-title" class="text-2xl font-extrabold mb-4 text-gray-800">Ch√∫c M·ª´ng Chi·∫øn Th·∫Øng!</h3>
                <p id="modal-content" class="mb-6 text-gray-600">B·∫°n ƒë√£ ho√†n th√†nh tr√≤ ch∆°i Solitaire!</p>
                <button onclick="hideModal(); initGame();" class="px-6 py-3 bg-red-600 text-white font-bold rounded-full hover:bg-red-500 transition shadow-lg">
                    Ch∆°i V√°n M·ªõi
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- 1. GAME CONSTANTS & DATA STRUCTURES ---

        const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        const RANK_VALUES = {'A': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13};
        const SUITS = ['H', 'D', 'C', 'S']; // Hearts (C∆°), Diamonds (R√¥), Clubs (Chu·ªìn), Spades (B√≠ch)
        const SUIT_SYMBOLS = {'H': '‚ô•', 'D': '‚ô¶', 'C': '‚ô£', 'S': '‚ô†'};

        // Tr·∫°ng th√°i game (C√°c c·ªçc b√†i)
        let gamePiles = {
            stock: [],    // B√†i r√∫t
            waste: [],    // B√†i ƒë√£ l·∫≠t
            foundations: {'H': [], 'D': [], 'C': [], 'S': []}, // 4 c·ªçc m·ª•c ti√™u
            tableau: [[], [], [], [], [], [], []] // 7 c·ªçc ch∆°i ch√≠nh
        };

        let selectedCardIndex = -1; // Index l√° b√†i ƒë∆∞·ª£c ch·ªçn trong c·ªçc
        let selectedPileType = null; // 'tableau', 'waste', ho·∫∑c 'foundation'
        let selectedPileIndex = -1; // Index c·ªçc b√†i ƒë∆∞·ª£c ch·ªçn (0-6 cho tableau)
        let score = 0;

        // --- 2. CARD CLASS (L·ªõp L√° B√†i) ---

        class Card {
            constructor(rank, suit) {
                this.rank = rank;
                this.suit = suit;
                this.isFaceUp = false;
            }

            isRed() {
                return this.suit === 'H' || this.suit === 'D';
            }

            getColor() {
                return this.isRed() ? 'red-suit' : 'black-suit';
            }

            getValue() {
                return RANK_VALUES[this.rank];
            }

            toString() {
                return this.rank + SUIT_SYMBOLS[this.suit];
            }
        }

        // --- 3. GAME LOGIC FUNCTIONS ---

        // Tr·ªôn b√†i (Thu·∫≠t to√°n Fisher-Yates)
        function shuffle(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }

        // T·∫°o b·ªô b√†i 52 l√°
        function createDeck() {
            const deck = [];
            for (const suit of SUITS) {
                for (const rank of RANKS) {
                    deck.push(new Card(rank, suit));
                }
            }
            return deck;
        }
        
        // C·∫≠p nh·∫≠t ƒëi·ªÉm
        function updateScore(points) {
            score += points;
            document.getElementById('current-score').textContent = score;
        }
        
        let messageTimeoutId = null; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ qu·∫£n l√Ω timeout

        // Hi·ªÉn th·ªã th√¥ng b√°o (kh√¥ng d√πng alert)
        function showMessage(msg) {
            const msgBox = document.getElementById('message-box');
            
            // 1. X√≥a timeout c≈© n·∫øu ƒëang ch·∫°y ƒë·ªÉ ngƒÉn th√¥ng b√°o c≈© ch√®n l√™n
            if (messageTimeoutId) {
                clearTimeout(messageTimeoutId);
            }
            
            msgBox.textContent = msg;
            msgBox.classList.add('text-[var(--primary-accent)]');
            
            // 2. ƒê·∫∑t timeout m·ªõi v√† l∆∞u ID
            messageTimeoutId = setTimeout(() => {
                msgBox.textContent = 'Ti·∫øp t·ª•c chi·∫øn n√†o!';
                msgBox.classList.remove('text-[var(--primary-accent)]');
                messageTimeoutId = null; // ƒê·∫∑t l·∫°i null sau khi ho√†n th√†nh
            }, 10000); // Th·ªùi gian ch·ªù 10 gi√¢y (10000ms)
        }

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            document.getElementById('game-modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('game-modal').classList.add('hidden');
        }


        // Ki·ªÉm tra ƒëi·ªÅu ki·ªán th·∫Øng
        function checkWinCondition() {
            let totalFoundationCards = 0;
            for (const suit in gamePiles.foundations) {
                totalFoundationCards += gamePiles.foundations[suit].length;
            }

            if (totalFoundationCards === 52) {
                showModal("CHI·∫æN TH·∫ÆNG L·ªäCH S·ª¨!", `Ch√∫c m·ª´ng Phong, b·∫°n ƒë√£ gi·∫£i Solitaire v·ªõi s·ªë ƒëi·ªÉm l√† ${score}!`);
                return true;
            }
            return false;
        }


        // --- 4. INITIALIZATION (Kh·ªüi T·∫°o Game) ---

        function initGame() {
            // 1. T·∫°o v√† tr·ªôn b√†i
            const deck = createDeck();
            shuffle(deck);

            // 2. Reset tr·∫°ng th√°i
            gamePiles.stock = deck;
            gamePiles.waste = [];
            gamePiles.foundations = {'H': [], 'D': [], 'C': [], 'S': []};
            gamePiles.tableau = [[], [], [], [], [], [], []];
            score = 0;
            document.getElementById('current-score').textContent = 0;
            showMessage('B·∫Øt ƒë·∫ßu v√°n m·ªõi! Ch√∫c may m·∫Øn.');
            resetSelection();
            
            // 3. Chia b√†i v√†o Tableau
            for (let i = 0; i < 7; i++) {
                for (let j = i; j < 7; j++) {
                    const card = gamePiles.stock.pop();
                    // L·∫≠t ng·ª≠a l√° cu·ªëi c√πng c·ªßa m·ªói c·ªçc
                    if (i === j) {
                        card.isFaceUp = true;
                    }
                    gamePiles.tableau[j].push(card);
                }
            }
            
            // 4. Render Game
            renderGame();
        }

        // --- 5. RENDERING (V·∫Ω L·∫°i Giao Di·ªán) ---

        function createCardElement(card, pileType, pileIndex, cardIndex) {
            const cardEl = document.createElement('div');
            cardEl.classList.add('card');
            
            // Th√™m data-attributes ƒë·ªÉ x·ª≠ l√Ω click
            cardEl.setAttribute('data-pile-type', pileType);
            cardEl.setAttribute('data-pile-index', pileIndex);
            cardEl.setAttribute('data-card-index', cardIndex);
            
            if (card.isFaceUp) {
                cardEl.classList.add(card.getColor());
                cardEl.innerHTML = `
                    <div class="text-xl">${card.rank}</div>
                    <div class="text-3xl">${SUIT_SYMBOLS[card.suit]}</div>
                    <div class="text-xl self-end transform rotate-180">${card.rank}</div>
                `;
            } else {
                cardEl.classList.add('card-back');
                cardEl.textContent = 'üÉè';
            }

            // X·ª≠ l√Ω s·ª± ki·ªán click
            cardEl.onclick = (e) => handleCardClick(e, pileType, pileIndex, cardIndex, card);
            
            return cardEl;
        }
        
        function renderPile(pile, elementId, pileType, pileIndex) {
            const container = document.getElementById(elementId);
            container.innerHTML = ''; // X√≥a n·ªôi dung c≈©
            
            if (pile.length === 0) {
                // ƒê·∫£m b·∫£o slot r·ªóng v·∫´n hi·ªán di·ªán
                container.classList.add('card-slot');
                return;
            }
            container.classList.remove('card-slot');
            container.style.position = 'relative';

            // T·∫°o v√† render t·ª´ng l√° b√†i
            pile.forEach((card, index) => {
                const cardEl = createCardElement(card, pileType, pileIndex, index);
                
                // V·ªã tr√≠ x·∫øp ch·ªìng (ch·ªâ √°p d·ª•ng cho Tableau)
                if (pileType === 'tableau') {
                    const offset = index * 25; // Kho·∫£ng c√°ch offset
                    cardEl.style.transform = `translateY(${offset}px)`;
                    cardEl.style.zIndex = index;
                    
                    // Th√™m l·ªõp n·∫øu l√† card ƒë√£ ch·ªçn (v√† t·∫•t c·∫£ c√°c card ph√≠a d∆∞·ªõi n√≥)
                    if (selectedPileType === 'tableau' && selectedPileIndex === pileIndex && index >= selectedCardIndex) {
                        cardEl.classList.add('selected');
                    }
                } else {
                    // Waste/Foundation: ch·ªâ hi·ªÉn th·ªã l√° tr√™n c√πng
                    cardEl.style.position = 'relative'; 
                }

                // N·∫øu l√† Waste/Foundation, ch·ªâ hi·ªÉn th·ªã l√° cu·ªëi c√πng (top card)
                if (pileType !== 'tableau' && index < pile.length - 1) {
                    cardEl.style.display = 'none';
                }

                container.appendChild(cardEl);
            });
        }
        
        function renderGame() {
            // Render Stock (C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng)
            document.getElementById('stock-count').textContent = gamePiles.stock.length > 0 ? gamePiles.stock.length : '‚ôªÔ∏è';
            if (gamePiles.stock.length === 0) {
                document.getElementById('stock-slot').classList.add('bg-gray-700', 'text-white');
            } else {
                document.getElementById('stock-slot').classList.remove('bg-gray-700', 'text-white');
            }

            // Render Waste
            renderPile(gamePiles.waste, 'waste-slot', 'waste', 0);
            
            // Render Foundations
            for (const suit of SUITS) {
                renderPile(gamePiles.foundations[suit], `foundation-${suit}`, 'foundation', suit);
            }

            // Render Tableau
            gamePiles.tableau.forEach((pile, index) => {
                renderPile(pile, `tableau-${index}`, 'tableau', index);
            });

            // Sau khi render, ki·ªÉm tra ƒëi·ªÅu ki·ªán th·∫Øng
            checkWinCondition();
        }

        // --- 6. MOVE LOGIC (X·ª≠ L√Ω Lu·∫≠t Ch∆°i) ---
        
        // Reset tr·∫°ng th√°i ch·ªçn
        function resetSelection() {
            if (selectedPileType) {
                // B·ªè highlight cho c√°c l√° b√†i ƒë√£ ch·ªçn
                document.querySelectorAll('.card.selected').forEach(el => el.classList.remove('selected'));
            }
            selectedCardIndex = -1;
            selectedPileType = null;
            selectedPileIndex = -1;
        }

        // H√†m x·ª≠ l√Ω khi ng∆∞·ªùi ch∆°i r√∫t b√†i t·ª´ Stock
        function drawCard() {
            // 1. Ki·ªÉm tra n·∫øu c√≥ b√†i trong Stock
            if (gamePiles.stock.length > 0) {
                const card = gamePiles.stock.pop();
                card.isFaceUp = true;
                gamePiles.waste.push(card);
                updateScore(5); // ƒêi·ªÉm khi r√∫t b√†i l·∫ßn ƒë·∫ßu
            } 
            // 2. N·∫øu Stock r·ªóng, chuy·ªÉn Waste v·ªÅ l·∫°i Stock
            else if (gamePiles.waste.length > 0) {
                while (gamePiles.waste.length > 0) {
                    const card = gamePiles.waste.pop();
                    card.isFaceUp = false; // L·∫≠t √∫p l·∫°i
                    gamePiles.stock.push(card);
                }
                updateScore(-10); // Ph·∫°t khi t√°i ch·∫ø b√†i
                showMessage('Stock h·∫øt b√†i! ƒê√£ t√°i ch·∫ø b√†i.');
            } else {
                 showMessage('Kh√¥ng c√≤n b√†i ƒë·ªÉ r√∫t!');
            }
            resetSelection();
            renderGame();
        }

        // H√†m ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa n∆∞·ªõc ƒëi Tableau -> Tableau
        function isValidTableauMove(targetPile, movedCards) {
            if (targetPile.length === 0) {
                // N·∫øu c·ªçc tr·ªëng, ch·ªâ ƒë∆∞·ª£c ƒë·∫∑t Vua (K)
                return movedCards[0].rank === 'K';
            }
            
            const targetCard = targetPile[targetPile.length - 1];
            const movingCard = movedCards[0];

            // 1. Ph·∫£i kh√°c m√†u
            const colorMatch = movingCard.isRed() !== targetCard.isRed();
            // 2. Rank ph·∫£i nh·ªè h∆°n 1 ƒë∆°n v·ªã
            const rankMatch = movingCard.getValue() === targetCard.getValue() - 1;

            return colorMatch && rankMatch;
        }

        // H√†m ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa n∆∞·ªõc ƒëi X -> Foundation
        function isValidFoundationMove(foundationPile, card) {
            // C·ªçc Foundation r·ªóng: Ch·ªâ ƒë∆∞·ª£c ƒë·∫∑t √Åt (A)
            if (foundationPile.length === 0) {
                return card.rank === 'A';
            }
            
            const topCard = foundationPile[foundationPile.length - 1];

            // 1. Ph·∫£i c√πng ch·∫•t
            const suitMatch = card.suit === topCard.suit;
            // 2. Rank ph·∫£i l·ªõn h∆°n 1 ƒë∆°n v·ªã
            const rankMatch = card.getValue() === topCard.getValue() + 1;

            return suitMatch && rankMatch;
        }


        // H√†m x·ª≠ l√Ω s·ª± ki·ªán click v√†o l√° b√†i ho·∫∑c v√πng ch·ª©a r·ªóng
        function handleCardClick(e, type, index, cardIndex, card) {
            e.stopPropagation(); // NgƒÉn ch·∫∑n s·ª± ki·ªán lan truy·ªÅn
            
            // 1. L·∫ßn Click ƒê·∫ßu Ti√™n: Ch·ªçn B√†i
            if (selectedPileType === null) {
                
                if (type === 'tableau' && card.isFaceUp) {
                    // Ch·ªçn m·ªôt stack trong Tableau
                    selectedCardIndex = cardIndex;
                    selectedPileType = type;
                    selectedPileIndex = index;
                    document.querySelectorAll('.card').forEach(el => el.classList.remove('selected'));
                    // Highlight t·∫•t c·∫£ c√°c l√° t·ª´ cardIndex tr·ªü l√™n
                    document.querySelectorAll(`[data-pile-type="tableau"][data-pile-index="${index}"]`).forEach(el => {
                        if (parseInt(el.getAttribute('data-card-index')) >= cardIndex) {
                            el.classList.add('selected');
                        }
                    });
                    showMessage(`ƒê√£ ch·ªçn l√° ${card.toString()}.`);
                    return;
                } 
                
                else if (type === 'waste' && cardIndex === gamePiles.waste.length - 1) {
                    // Ch·ªâ ch·ªçn l√° tr√™n c√πng c·ªßa Waste
                    selectedCardIndex = cardIndex;
                    selectedPileType = type;
                    selectedPileIndex = index;
                    e.currentTarget.classList.add('selected');
                    showMessage(`ƒê√£ ch·ªçn l√° ${card.toString()} t·ª´ Waste.`);
                    return;
                }
                
                else if (type === 'foundation' && cardIndex === gamePiles.foundations[index].length - 1) {
                    // Kh√¥ng cho ph√©p ch·ªçn t·ª´ Foundation
                    showMessage('Kh√¥ng ƒë∆∞·ª£c di chuy·ªÉn b√†i ra kh·ªèi Foundation!');
                    return;
                }
                
                else {
                    // B·ªè qua n·∫øu l√† b√†i √∫p ho·∫∑c kh√¥ng ph·∫£i l√° tr√™n c√πng
                    return;
                }
            } 
            
            // 2. L·∫ßn Click Th·ª© Hai: Di Chuy·ªÉn B√†i (Target)
            else {
                // L·∫•y c√°c l√° b√†i ƒëang ƒë∆∞·ª£c ch·ªçn
                let sourcePile;
                let movedCards;
                let scorePoints = 0;

                if (selectedPileType === 'waste') {
                    sourcePile = gamePiles.waste;
                    movedCards = [sourcePile[sourcePile.length - 1]];
                } else if (selectedPileType === 'tableau') {
                    sourcePile = gamePiles.tableau[selectedPileIndex];
                    movedCards = sourcePile.slice(selectedCardIndex);
                } else {
                    // Tr∆∞·ªùng h·ª£p n√†y kh√¥ng n√™n x·∫£y ra
                    resetSelection();
                    renderGame();
                    return;
                }

                let moveSuccessful = false;

                // THAY ƒê·ªîI C·ªåC ƒê√çCH: Tableau
                if (type === 'tableau') {
                    const targetPile = gamePiles.tableau[index];
                    if (isValidTableauMove(targetPile, movedCards)) {
                        targetPile.push(...movedCards);
                        // X√≥a c√°c l√° ƒë√£ di chuy·ªÉn kh·ªèi c·ªçc ngu·ªìn
                        sourcePile.splice(selectedCardIndex);
                        moveSuccessful = true;
                        
                        // T√≠nh ƒëi·ªÉm: Waste/Foundation -> Tableau (+5), Tableau -> Tableau (0)
                        if (selectedPileType === 'waste') {
                            scorePoints = 5;
                        }
                    } else {
                        showMessage('Kh√¥ng th·ªÉ ƒë·∫∑t b√†i ·ªü ƒë√¢y! (L·ªách m√†u ho·∫∑c th·ª© t·ª±)');
                    }
                } 
                
                // THAY ƒê·ªîI C·ªåC ƒê√çCH: Foundation
                else if (type === 'foundation') {
                    // Ch·ªâ ƒë∆∞·ª£c di chuy·ªÉn 1 l√°
                    if (movedCards.length === 1 && isValidFoundationMove(gamePiles.foundations[index], movedCards[0])) {
                        gamePiles.foundations[index].push(movedCards[0]);
                        // X√≥a l√° ƒë√£ di chuy·ªÉn kh·ªèi c·ªçc ngu·ªìn
                        sourcePile.pop();
                        moveSuccessful = true;
                        scorePoints = 10; // ƒêi·ªÉm khi di chuy·ªÉn v√†o Foundation
                    } else if (movedCards.length > 1) {
                        showMessage('Ch·ªâ ƒë∆∞·ª£c di chuy·ªÉn T·ª™NG L√Å M·ªòT v√†o Foundation!');
                    } else {
                        showMessage('Kh√¥ng th·ªÉ ƒë·∫∑t b√†i ·ªü Foundation! (Sai ch·∫•t ho·∫∑c th·ª© t·ª±)');
                    }
                }
                
                // THAY ƒê·ªîI C·ªåC ƒê√çCH: Click l·∫°i v√†o l√° ƒë√£ ch·ªçn (h·ªßy ch·ªçn)
                else if (type === selectedPileType && index === selectedPileIndex && cardIndex >= selectedCardIndex) {
                    resetSelection();
                    renderGame();
                    return;
                }


                // X·ª¨ L√ù SAU KHI DI CHUY·ªÇN TH√ÄNH C√îNG
                if (moveSuccessful) {
                    updateScore(scorePoints);
                    showMessage('N∆∞·ªõc ƒëi h·ª£p l·ªá! Go go go!');
                    
                    // L·∫≠t l√° b√†i ti·∫øp theo trong Tableau n·∫øu c·∫ßn
                    if (selectedPileType === 'tableau' && sourcePile.length > 0) {
                        const topCard = sourcePile[sourcePile.length - 1];
                        if (!topCard.isFaceUp) {
                            topCard.isFaceUp = true;
                            updateScore(5); // ƒêi·ªÉm l·∫≠t b√†i
                            showMessage('ƒê√£ l·∫≠t b√†i m·ªõi (+5 ƒëi·ªÉm)!');
                        }
                    }
                }
                
                // Reset tr·∫°ng th√°i ch·ªçn sau khi th·ª≠ di chuy·ªÉn
                resetSelection();
                renderGame();
                return;
            }
        }


        // X·ª≠ l√Ω click v√†o v√πng ch·ª©a r·ªóng c·ªßa Tableau (Ch·ªâ cho ph√©p ƒë·∫∑t VUA)
        document.querySelectorAll('.tableau-slot').forEach((slot, index) => {
            slot.addEventListener('click', () => {
                if (gamePiles.tableau[index].length === 0 && selectedPileType) {
                    
                    let sourcePile;
                    let movedCards;
                    
                    if (selectedPileType === 'waste') {
                        sourcePile = gamePiles.waste;
                        movedCards = [sourcePile[sourcePile.length - 1]];
                    } else if (selectedPileType === 'tableau') {
                        sourcePile = gamePiles.tableau[selectedPileIndex];
                        movedCards = sourcePile.slice(selectedCardIndex);
                    } else {
                        resetSelection();
                        renderGame();
                        return;
                    }

                    // N·∫øu c·ªçc tr·ªëng, ch·ªâ ƒë∆∞·ª£c ƒë·∫∑t Vua (K)
                    if (movedCards[0].rank === 'K') {
                        gamePiles.tableau[index].push(...movedCards);
                        sourcePile.splice(selectedCardIndex);
                        
                        // L·∫≠t b√†i ngu·ªìn n·∫øu c·∫ßn (gi·ªëng logic tr√™n)
                        if (selectedPileType === 'tableau' && sourcePile.length > 0) {
                            const topCard = sourcePile[sourcePile.length - 1];
                            if (!topCard.isFaceUp) {
                                topCard.isFaceUp = true;
                                updateScore(5); 
                            }
                        }

                        updateScore(5); // ƒêi·ªÉm khi ƒë·∫∑t Vua v√†o c·ªçc tr·ªëng
                        showMessage('ƒê·∫∑t Vua h·ª£p l·ªá!');
                        resetSelection();
                        renderGame();
                        return;
                    } else {
                        showMessage('C·ªçc tr·ªëng ch·ªâ ch·∫•p nh·∫≠n Vua (K)!');
                    }
                }
                
                // N·∫øu click v√†o slot r·ªóng m√† kh√¥ng c√≥ b√†i ƒë∆∞·ª£c ch·ªçn, reset selection
                resetSelection();
                renderGame();
            });
        });
        
        // --- 7. PWA Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker ƒë√£ ƒëƒÉng k√Ω th√†nh c√¥ng:', registration.scope);
                    })
                    .catch(error => {
                        console.error('ƒêƒÉng k√Ω Service Worker th·∫•t b·∫°i:', error);
                    });
            });
        }
        
        // B·∫Øt ƒë·∫ßu game khi t·∫£i trang
        window.onload = initGame;

    </script>
</body>
</html>
